name: CD - Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub (Optional)
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false  # Set to true if using Docker Hub
        tags: |
          melk-ai:latest
          melk-ai:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd ~/melkai-aimodule
          git pull origin main
          sudo docker-compose down
          sudo docker-compose build --no-cache
          sudo docker-compose up -d
          echo "‚úÖ Deployment complete"
          sudo docker-compose ps
          sudo docker-compose logs --tail=50
    
    - name: Health check
      run: |
        echo "Waiting for service to start..."
        sleep 15
        echo "Testing health endpoint..."
        curl -f http://18.119.209.125:8000/health || exit 1
        echo "Testing via domain..."
        curl -f https://melkpm.duckdns.org/health || exit 1
        echo "‚úÖ Deployment completed and health checks passed"
    
    - name: Notify on success
      if: success()
      run: |
        echo "üöÄ Deployment successful!"
        echo "Version: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "API Docs: https://melkpm.duckdns.org/docs"
        echo "Health: https://melkpm.duckdns.org/health"
        echo "Server: EC2 18.119.209.125:8000"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Check logs above for details"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd ~/melkai-aimodule
          sudo docker-compose down
          git checkout HEAD~1
          sudo docker-compose build --no-cache
          sudo docker-compose up -d
          echo "‚ö†Ô∏è Rolled back to previous version"
          sudo docker-compose ps
