name: CD - Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Check if directory exists and is a git repo
          if [ ! -d ~/melkai-aimodule/.git ]; then
            echo "‚ö†Ô∏è Git repo not found, cloning fresh..."
            rm -rf ~/melkai-aimodule
            git clone https://github.com/zain-0/melkai-aimodule.git ~/melkai-aimodule
            echo "‚úÖ Repo cloned successfully"
          else
            echo "üìÇ Git repo found, pulling latest changes..."
            cd ~/melkai-aimodule
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          fi
          
          # Verify we're in the right directory
          cd ~/melkai-aimodule
          echo "üìç Current directory: $(pwd)"
          echo "üìÑ Files: $(ls -la)"
          
          # Deploy with docker
          sudo docker-compose down || true
          sudo docker-compose build --no-cache
          sudo docker-compose up -d
          echo "‚úÖ Deployment complete"
          sudo docker-compose ps
          sudo docker-compose logs --tail=50
    
    - name: Health check
      run: |
        echo "Waiting for service to start..."
        sleep 15
        echo "Testing health endpoint..."
        curl -f http://18.119.209.125:8000/health || exit 1
        echo "Testing via domain..."
        curl -f https://melkpm.duckdns.org/health || exit 1
        echo "‚úÖ Deployment completed and health checks passed"
    
    - name: Notify on success
      if: success()
      run: |
        echo "üöÄ Deployment successful!"
        echo "Version: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "API Docs: https://melkpm.duckdns.org/docs"
        echo "Health: https://melkpm.duckdns.org/health"
        echo "Server: EC2 18.119.209.125:8000"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Check logs above for details"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd ~/melkai-aimodule
          sudo docker-compose down
          git checkout HEAD~1
          sudo docker-compose build --no-cache
          sudo docker-compose up -d
          echo "‚ö†Ô∏è Rolled back to previous version"
          sudo docker-compose ps
